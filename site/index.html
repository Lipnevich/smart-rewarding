<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Reward</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/waves-api.min.js"></script>
    <script src="js/GitHub.bundle.min.js"></script>
</head>
<body onload="testInit()">

<div id="container">
    <h1>Smart Salary Processor</h1>
    <div class="tab">

        <p>We are happy to introduce Smart Salary Processor for Software developers. It manages salary payments for your employees according to their productivity</p>
        <p>All you have to do is provide GitHub repository name, developers Waves wallets, and amount of money you want to spend on salaries
        <p>Smart salary processor will check amount of commits of each of developer and spread provided money in proportion of completed job with transactions protected by Waves smart contract</p>
        <p id="welcomeMessage"></p>
    </div>

    <div class="tab">
        <p>Your GitHub project</p>
        <p>
            https://github.com/
            <input placeholder="Profile name..." id="profileId" />
            /
            <input placeholder="Repository name..." id="repositoryId" />
        </p>
        <p id="repositoryMessage"></p>
    </div>

    <div class="tab">
        <p>Waves wallet for <a target="_blank" id="repositoryLink">your GitHub repository</a>:</p>
        <div class="code" id="walletId"></div>
        <p id="walletMessage"></p>
    </div>

    <div class="tab">
        <p>Waves wallets for developers you want to reward</p>
        <div id="teamId"></div>
        <p id="teamMessage"></p>
    </div>

    <div class="tab">
        <p><a target="_blank" id="contractLink">Waves smart contract</a> that allows transfer money to your developers only</p>
        <p>Wallets for your developers and salary amounts stored in <a target="_blank" id="dataLink">Waves blockchain</a></p>
        <p id="salariesId"></p>
        <p id="salariesMessage"></p>
    </div>


    <div class="navigation">
        <!--<a id="test" style="background: green;" onclick="testData()">TEST</a>-->
        <a id="prevBtn" onclick="this.disabled=true;nextPrev(-1)"></a>
        <a id="nextBtn" onclick="this.disabled=true;nextPrev(1)"></a>
    </div>

    <div class="steps">
        <span class="step"></span>
        <span class="step"></span>
        <span class="step"></span>
        <span class="step"></span>
        <span class="step"></span>
    </div>
</div>
<div id='logger'>&hellip;</div>

<script>

    <!--++++++++++++++++++++++++++++++++++++ UI +++++++++++++++++++++++++++++++++++++++-->

    var currentTab = 0;
    var progress = 0;
    showTab(0);

    async function showTab(tabIndex) {
      var tabs = document.getElementsByClassName('tab');
      tabs[tabIndex].style.display = 'block';

      document.getElementById('nextBtn').disabled = false;
      document.getElementById('prevBtn').disabled = false;
      document.getElementById('nextBtn').style.display = 'inline';
      document.getElementById('prevBtn').style.display = 'inline';
      document.getElementById('nextBtn').style.background = '#ffa100';
      document.getElementById('prevBtn').textContent = 'Previous';

      if (tabIndex == 0) {
        document.getElementById('prevBtn').style.display = 'none';
        document.getElementById('nextBtn').textContent = 'Start';
      } else if (tabIndex == (tabs.length - 1)) {
        document.getElementById('nextBtn').style.background = '#039be5';
        document.getElementById('nextBtn').textContent = 'Pay Salaries';
      } else {
        document.getElementById('nextBtn').textContent = 'Next';
      }

      fixStepIndicator(tabIndex);
    }

    function fixStepIndicator(stepIndex) {
      let steps = document.getElementsByClassName('step');
      for (let step of steps) {
        step.className = step.className.replace(' active', '');
      }
      steps[stepIndex].className += ' active';
    }

    async function validateTab() {
      if(progress > currentTab) return true;
      let valid = true;
      let tabs = document.getElementsByClassName('tab');
      inputs = tabs[currentTab].getElementsByTagName('input');
      for (let input of inputs) {
        if (input.value == '') {
          input.className += ' invalid';
          valid = false;
        }
      }

      if (valid) {
          switch(currentTab) {
            case 1 : valid = await checkRepository();  break;
            case 2 : valid = balance >= 0.01; break;
            case 3 : valid = await smartContract(document.getElementById('teamMessage')); break;
            case 4 : valid = await paySalaries(document.getElementById('salariesMessage')); break;
          }


            progress++;
            for (let input of inputs) {
              input.disabled = true;
            }
      }
      return valid;
    }

    async function nextPrev(n) {
      let tabs = document.getElementsByClassName('tab');
      if (n == 1 && !await validateTab()) return false;
      if((currentTab + n) == tabs.length) {
        document.getElementById('nextBtn').disabled = true;
        return false;
      }
      tabs[currentTab].style.display = 'none';
      currentTab = currentTab + n;
      showTab(currentTab);
    }

    let developers = [];
    function showTeam() {
        for(let developerIndex in developers) {
            let developer = developers[developerIndex];
            let member = document.createElement('p');

            let devDesc = document.createElement('div');
            devDesc.textContent = developer.name + ' (' + (developer.part * 100).toFixed(0) + '%) ';
            member.appendChild(devDesc);

            let devWallet = document.createElement('input');
            devWallet.setAttribute('placeholder', developer.name + ' wallet');
            devWallet.setAttribute('id','devWallet' + developerIndex);
            devWallet.value = developer.recipient;
            member.appendChild(devWallet);

            let team = document.getElementById('teamId');
            if(team.children.length <= developers.length) {
                team.appendChild(member);
            }
        }
    }

    function disableRedundantById(id){
        document.getElementById(id).disabled = true;
    }

    function removeRedundantById(id){
         let iElement = document.getElementById(id);
         iElement.parentNode.removeChild(iElement);
    }

    function info(message) {
        let logger = document.getElementById('logger');
        logger.style.color = 'green';
        logger.textContent = 'SUCCESS. ' + message;
        setTimeout(clearLog, 2000, logger.textContent);
    }

    function clearLog(message) {
        let logger = document.getElementById('logger');
        if(logger.textContent == message) {
            logger.style.color = 'green';
            logger.textContent = '...';
        }
    }

    function warn(message) {
        let logger = document.getElementById('logger');
        logger.style.color = 'red';
        logger.textContent = 'ERROR. ' + message;
        setTimeout(clearLog, 2000, logger.textContent);
    }

    <!--=============================== UI ===================================-->

    <!--++++++++++++++++++++++++++++++++++++ GITHUB +++++++++++++++++++++++++++++++++++++++-->

    const GITHUB = new GitHub();

    async function checkRepository() {
        let message = document.getElementById('repositoryMessage');
        message.textContent = 'Checking repository. Please wait...';
        let profileName = document.getElementById('profileId').value;
        let repositoryName = document.getElementById('repositoryId').value;

        try {
            let commits = await GITHUB.getRepo(profileName,repositoryName).listCommits();
            document.getElementById('repositoryLink').href = 'https://github.com/' + profileName + '/' + repositoryName;

            let names = new Set();
            for(let data of commits.data) {
                let name = data.commit.committer.name;
                if(name != 'GitHub') {
                    names.add(data.commit.committer.name);
                }
            }
            if(names.size == 0) {
                message.textContent = 'Repository with no commits. Please start developing first';
                return false;
            }
            if(names.size == developers.length) {
                return true;
            }

            let index = 0;
            for(let name of names) {
                let developer = {name : name, recipient : '', commits: 0};
                if(preWallet[index]) developer.recipient = preWallet[index];
                developers.push(developer);
                index++;
            }


            let total = commits.data.length - 1;
            for(let data of commits.data) {
                info(data.commit.committer.name + ' ' + data.commit.author.name + ' '  +  data.commit.message);

                for(let author of developers) {
                    if(author.name === data.commit.committer.name) {
                        author.commits++;
                    }

                }
            }

            for(let author of developers) {
                let part = author.commits / total;
                author.part = part;
            }

            message.textContent = '';
            showTeam();
            processWallet();
            return true;
        } catch(e) {
            message.textContent = e;
            warn(JSON.stringify(e.response.status + ' ' + e.response.statusText));
        };
    }

    <!--=============================== GITHUB ===================================-->

    <!--++++++++++++++++++++++++++++++++++++ WAVES +++++++++++++++++++++++++++++++++++++++-->

    const DECIMALS = 100000000;
    const WAVES = WavesAPI.create(WavesAPI.TESTNET_CONFIG);
    const WAVES_EXPLORER_LINK = 'https://testnet.wavesexplorer.com/address/';

    let currentWallet;
    let balance = -1;

    async function processWallet(key){
        if(!currentWallet) {
            currentWallet = WAVES.Seed.create();
        }
        document.getElementById('walletId').textContent = currentWallet.address;
        document.getElementById('contractLink').href = WAVES_EXPLORER_LINK + currentWallet.address;
        document.getElementById('dataLink').href = WAVES_EXPLORER_LINK + currentWallet.address;
        showBalance();
    }

    function showBalance() {
        if(balance >= 0.01) {
            document.getElementById('walletMessage').textContent =  'Current balance is ' + balance + ' Waves';

            let moneyTotal = balance;
            for(let author of developers) {
                if(author.commits > 0) {
                    moneyTotal-=0.005;
                }
            }
            moneyTotal *= 0.1;

            for(let author of developers) {
                author.amount = (moneyTotal * author.part).toFixed(3);
                info(author.name + ' made ' + author.commits + ' commits (' + (author.part * 100).toFixed(0)
                    + '%). Salary is ' + author.amount);
            }

        } else if(balance >= 0) {

            document.getElementById('walletMessage').textContent = 'Current balance is '
                + balance + ' Waves. Please send at least ' + ((0.005 * developers.length + 0.01) - balance) + ' Waves for creating smart contract';
            setTimeout(checkBalance, 1000);
        } else {
            document.getElementById('walletMessage').textContent = 'Checking balance. Please wait...';
            setTimeout(checkBalance, 1000);
        }
    }

    function checkBalance(){
        WAVES.API.Node.addresses.balanceDetails(currentWallet.address).then(balanceDetails => {
            balance = balanceDetails.available / DECIMALS;
            showBalance();
        }).catch(e => {
            warn(e.message);
        });
    }

    async function smartContract(messageElement) {
        await publishDataTx();

        let smartContract = `
            let signature = base58'${currentWallet.keyPair.publicKey}';

            match tx { case tx:TransferTransaction =>
                       {
                            let employerAddress = addressFromPublicKey(tx.senderPk);
                            let dateKey = toBase58String(addressFromRecipient(tx.recipient).bytes);
                            let salary = extract(getLong(employerAddress, dateKey));
                            if((salary == tx.amount) && sigVerify(tx.bodyBytes, tx.proofs[0], signature)) then true else false
                       } case _ => true }
        `;

        try {
            messageElement.textContent = 'Compiling Waves smart contract. Please wait...';
            let compiledContract = await WAVES.API.Node.utils.script.compile(smartContract);

            const contractTransaction = {
                fee: DECIMALS * 0.005,
                script: compiledContract,
                sender: currentWallet.address,
                senderPublicKey: currentWallet.keyPair.publicKey
            };

            messageElement.textContent = 'Publishing Waves smart contract. Please wait...';
            let publishedContract = await WAVES.API.Node.transactions
                .broadcast(WAVES.constants.SET_SCRIPT_TX_NAME, contractTransaction, currentWallet.keyPair);
            messageElement.textContent = 'Publishing Data in Waves Blockchain. Please wait...';

            messageElement.textContent = '';

            return true;
        } catch (e) {
            messageElement.textContent = e ;
            warn(e.error);
            return false;
        }
    }

    async function publishDataTx(){
        let arrayData = [];
        for(let developer of developers){
            let amount = Math.floor(developer.amount * DECIMALS);
            let data = {
                key: developer.recipient,
                type: 'integer',
                value: amount
            };
            arrayData.push(data);
        }

        const dataTransaction = {
            sender: currentWallet.address,
            senderPublicKey: currentWallet.keyPair.publicKey,
            fee: DECIMALS * 0.005,
            data: arrayData
        };

        const transferred = await WAVES.API.Node.transactions
            .broadcast(WAVES.constants.DATA_TX_NAME, dataTransaction, currentWallet.keyPair);

        for(let developer of developers){
            let salary = document.createElement('div');
            salary.setAttribute('class','code');
            salary.textContent = 'Salary for ' + developer.name + ' is ' + developer.amount + ' Waves';

            document.getElementById('salariesId').appendChild(salary);
        }
        return arrayData;
    }

    async function paySalaries(messageContainer){
        for(let developer of developers) {
            messageContainer.textContent = 'Sending salary to ' + developer.name + '. Please wait...';
            try {
                await transfer(developer, currentWallet.keyPair);
            } catch (e) {
                warn(e.error);
                messageContainer.textContent = e;
                return false;
            }
        }
        messageContainer.textContent = 'Salaries were sent. Thanks for choosing us';
        showBalance();
        return true;
    }

    async function transfer(developer, keyPair){
        const transferTransaction = {
            assetId: 'WAVES',
            feeAssetId: 'WAVES',
            fee: DECIMALS * 0.005,
            attachment: '',
            amount: Math.floor(developer.amount * DECIMALS),
            recipient: developer.recipient,
            timestamp: Date.now()
        };

        const transferred = await WAVES.API.Node.transactions
            .broadcast(WAVES.constants.TRANSFER_TX_NAME, transferTransaction, keyPair);
        info(`Waves ${developer.amount} transferred to ${developer.recipient}.`);
    }


    <!--========================== WAVES ===============================-->

    <!--++++++++++++++++++++++++TEST+++++++++++++++++++++++++++++-->

    let preWallet = ['3NA1cH18k2tpbLewPJWNTVuR3LVjCyerSgB', '3Mxhn7bk9qcYv7E2Lgct2oPSUYiGWN7iB3x'];

    async function testInit(){
        <!--currentWallet = WAVES.Seed.fromExistingPhrase('income desk floor glide act forward pilot poet evoke squirrel circle april pupil razor pole');-->

        document.getElementById('profileId').value = 'Lipnevich';
        document.getElementById('repositoryId').value = 'smart-rewarding';
    }

    async function testData() {
        developers = [{name : 'Lipnevich', amount : 0.55555555, recipient: '3NA1cH18k2tpbLewPJWNTVuR3LVjCyerSgB'}];
        try {
            <!--await publishDataTx();-->
            <!--await smartContract(document.getElementById('welcomeMessage'));-->
            <!--await paySalaries(document.getElementById('welcomeMessage'));-->
        } catch (e) {
            warn(e.message);
            document.getElementById('welcomeMessage').textContent = e;
        }
    }

    <!--============================TEST==============================-->

</script>

</body>
</html>