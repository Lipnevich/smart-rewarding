<html>
<head>
<meta charset="utf-8">
<title>Smart Reward</title>
<script src="./node_modules/@waves/waves-api/dist/waves-api.min.js"></script>
<script src="./node_modules/github-api/dist/GitHub.bundle.min.js"></script>
<script>

    const Waves = WavesAPI.create(WavesAPI.TESTNET_CONFIG);
    const git = new GitHub();
    let balanceCheckTimer;
    let currentWallet;

    function checkRepository(){
        let profileName = document.getElementById('profileId').value;
        let repositoryName = document.getElementById('repositoryId').value;
        git.getRepo(profileName,repositoryName).getDetails().then(() => {
                showWallet('aa'+ profileName + repositoryName);
            }).catch(e => {
                document.getElementById('errorMessageId').textContent = e;
                document.getElementById('container').style.display = 'none';
            });

    }

    function showWallet(key){
        let currentAlias = key.substring(0, Math.min(30, key.length)).toLowerCase();
        document.getElementById('userWalletId').style.display  = "block";
        document.getElementById('errorMessageId').textContent = '';
        Waves.API.Node.aliases.byAlias(currentAlias).then(wallet => {
            currentWallet = wallet;
            currentWallet.alias = currentAlias;
            currentWallet.aliasCreated = true;
            displayBalance();
        }).catch(e => {
            currentWallet = Waves.Seed.create();
            currentWallet.alias = currentAlias;
            displayBalance();
        });
    }

    async function displayBalance(){
        document.getElementById('initRepoId').style.display = 'none';
        balanceCheckTimer = setInterval(startTimerWithInterval, 1000);
    }

    function startTimerWithInterval(){
        Waves.API.Node.addresses.balanceDetails(currentWallet.address).then(balanceDetails => {
            let currentBalance = balanceDetails.available / 100000000;
            if(currentBalance > 0.01) {
                createAlias();
                createSmartContract();
            }
            document.getElementById('userWalletId').textContent = 'Адрес кошелька - ' + currentWallet.address + ' Баланс - ' + currentBalance;
        }).catch(e => {
            document.getElementById('errorMessageId').textContent = e.message;
            document.getElementById('container').style.display = 'none';
        });;
    }

    async function createAlias(){
        let createAlias = {
            alias: currentWallet.alias,
            fee: 100000,
            timestamp: Date.now()
        };
        document.getElementById('containerTest').textContent = JSON.stringify(currentWallet);
        await Waves.API.Node.transactions.broadcast('createAlias', createAlias, currentWallet.seed.keyPair);
    }


    function createSmartContract(){

    }

    </script>

</head>
<body>


<div align="center">
    <div id="initRepoId">
        https://github.com/
        <input type="text" value="VladislawKravchenok" size="20" id="profileId" placeholder="Profile name"/>
        /
        <input type="text" value="SolarSystem3" size="20" id="repositoryId" placeholder="Repository name"/>


        <button onclick="checkRepository()" id="createButtonId"> Создать\подключить кашелёк</button>
    </div>


    <div id="userWalletId"></div>

    <input type="text" name="key" size="15" id="accountId"
           placeholder="Ссылка на гит аккаунта работника" hidden/>



    <input type="text" name="key" size="15" id="walletId"
           placeholder="Личный, Waves - кашелёк работника" hidden/>


<div id="container" style="text-align: center">   </div>
<div id="containerTest" style="text-align: center">   </div>
<div id="errorMessageId" style=" color: red"></div>
</div>
</body>
</html>