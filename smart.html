<html>
<head>
<meta charset="utf-8">
<title>Smart Reward</title>
<script src="./node_modules/@waves/waves-api/dist/waves-api.min.js"></script>
<script src="./node_modules/github-api/dist/GitHub.bundle.min.js"></script>
<script>
    const decimal = 100000000;
    const Waves = WavesAPI.create(WavesAPI.TESTNET_CONFIG);
    const git = new GitHub();
    let balanceCheckTimer;
    let currentWallet;

    function test(){
        currentWallet = Waves.Seed.fromExistingPhrase('garden dress beach push earth ski below notice cry submit parade involve creek special glue');
        let devArray = [{recipient:'3NA1cH18k2tpbLewPJWNTVuR3LVjCyerSgB',amount:0.02 * decimal}];
        testSmart();
    }
    function checkRepository(){
        let profileName = document.getElementById('profileId').value;
        let repositoryName = document.getElementById('repositoryId').value;
        git.getRepo(profileName,repositoryName).getDetails().then(() => {
                showWallet('aa'+ profileName + repositoryName);
            }).catch(e => {
                document.getElementById('errorMessageId').textContent = e;
                document.getElementById('container').style.display = 'none';
            });

    }

    function showWallet(key){
        document.getElementById('errorMessageId').textContent = '';
        currentWallet = Waves.Seed.fromExistingPhrase('garden dress beach push earth ski below notice cry submit parade involve creek special glue');
        displayBalance();
    }

    async function displayBalance(){
        document.getElementById('initRepoId').style.display = 'none';
        balanceCheckTimer = setInterval(startTimerWithInterval, 1000);
    }

    function startTimerWithInterval(){
        Waves.API.Node.addresses.balanceDetails(currentWallet.address).then(balanceDetails => {
            let currentBalance = balanceDetails.available / decimal;
            if(currentBalance > 0.01) {
                clearInterval(balanceCheckTimer);
                addDeveloper();
            }
            document.getElementById('userWalletId').textContent = 'Wallet address - ' + currentWallet.address;
            document.getElementById('userBalanceId').textContent =  'Balance - ' + currentBalance + ' Waves';
            document.getElementById('userSeedId').textContent = 'Seed - ' + currentWallet.phrase;
        }).catch(e => {
            clearInterval(balanceCheckTimer);
            document.getElementById('errorMessageId').textContent = e.message;
            document.getElementById('container').style.display = 'none';
        });;
    }

    let developers = 0;
    function addDeveloper(){

           let container = document.getElementById('container');
           let row = document.createElement('div');

           if(developers === 0){
           let buttonContainer = document.getElementById('buttonCreateSmartContract');
           let button = document.createElement('button');
           button.setAttribute('onclick','createSmartContract()');
           button.innerText = 'Create smart contract';
           buttonContainer.appendChild(button);
           }

           developers++;

           let devName = document.createElement('input');
           devName.setAttribute('size',20);
           devName.setAttribute('type','text');
           devName.setAttribute('placeholder','Developer name');
           devName.setAttribute('id','devName' + developers);
           row.appendChild(devName);
           container.appendChild(row);

           let devWallet = document.createElement('input');
           devWallet.setAttribute('size',20);
           devWallet.setAttribute('type','text');
           devWallet.setAttribute('placeholder','Developer wallet');
           devWallet.setAttribute('id','devWallet' + developers);
           row.appendChild(devWallet);
           container.appendChild(row);

           let buttonAdd = document.createElement('button');
           buttonAdd.setAttribute('onclick','addDeveloper()');
           buttonAdd.innerText = 'add';
           row.appendChild(buttonAdd);
           container.appendChild(row);
    }

    let smart;

    function testSmart(){
        smart = `let chiefPubKey = base58'5iWWTVEqyPmqvyKGLYbue4yGhTjUM1KSyssaqMeWWQWy'
        let developer0 = '3NA1cH18k2tpbLewPJWNTVuR3LVjCyerSgB'
        <!--let developer0 = extract(addressFromString('3NA1cH18k2tpbLewPJWNTVuR3LVjCyerSgB')).bytes-->
        match tx { case tx:TransferTransaction =>
        <!--let txRecipient = addressFromRecipient(tx.recipient).bytes-->
        if(sigVerify(tx.bodyBytes, tx.proofs[0], chiefPubKey)) then true else false
        <!--if((developer == txRecipient) && sigVerify(tx.bodyBytes, tx.proofs[0], chiefPubKey)) then true else false-->
        case _ => true}`;

        let container = document.getElementById('container');
        container.textContent = smart;

        Waves.API.Node.utils.script.compile(smart).then(compiledScript=>{
            deploySmartContract(compiledScript);
        });
    }

    function createSmartContract(developersArray){

        smart = "let chiefPubKey = base58'${currentWallet.keyPair.publicKey}'";
        smart += '\n';
        for(let i = 0; i < developersArray.length;i++){
            smart += "let developer" + i + " = extract(addressFromString('" + developersArray[i].recipient + "')).bytes";
            smart += '\n';
        }

        smart += "match tx { case tx:TransferTransaction =>";
        smart += '\n';
        for(let i = 0; i<developersArray.length; i++){
            smart += "let txRecipient" + i + " = addressFromRecipient(tx.recipient).bytes";
             smart += '\n';
        }

        smart += "if(";
        for(let i = 0; i < developersArray.length; i++){
            smart += "(developer" + i + " == txRecipient" + i + ")";
            if(i + 1 < developersArray.length){
            smart += ' ||';
            }
        }
        smart += ' && sigVerify(tx.bodyBytes,tx.proofs[0],chiefPubKey)) then true else false';
         smart += '\n';
        smart += 'case _ => true';

        let container = document.getElementById('container');
        container.textContent = smart;

        Waves.API.Node.utils.script.compile(smart).then(compiledScript=>{
            deploySmartContract(compiledScript);
        });
    }

    async function deploySmartContract(compiledScript){
        const setScriptObj = Object.assign(Helpers.TX_EXAMPLES.SET_SCRIPT, {
            script: compiledScript,
            sender: currentWallet.address,
            senderPublicKey: currentWallet.keyPair.publicKey
            });
        const setScriptTx = await Waves.tools.createTransaction(Waves.constants.SET_SCRIPT_TX_NAME, setScriptObj);
        setScriptTx.addProof(elephantAccount.keyPair.privateKey);
    }

    async function signTransaction(){
        let currentBalance;
        Waves.API.Node.addresses.balanceDetails(currentWallet.address).then(balanceDetails => {
            currentBalance = balanceDetails.available;
        });

        for(let i = 0;i<developers;i++){
            const transferTxObj = Object.assign(Helpers.TX_EXAMPLES.TRANSFER, {
                recipient: document.getElementById('devWallet' + i).address,
                amount: decimal * 0.01,
                sender: currentWallet.address,
                senderPublicKey: currentWallet.keyPair.publicKey
            });
            const transferTx = await Waves.tools.createTransaction(Waves.constants.TRANSFER_TX_NAME, transferTxObj);
            transferTx.addProof(currentWallet.keyPair.privateKey);
            const transferTxJSON = await transferTx.getJSON();
        }

    }
    function transferMoney(){
        for(let i = 0;i<developers;i++){
            const transferData = {
            recipient: document.getElementById('devWallet' + i).address,
            assetId: 'WAVES',
            amount: decimal * 0.02,
            feeAssetId: 'WAVES',
            fee: decimal * 0.001,
            attachment: '',
            timestamp: Date.now()
        };
        Waves.API.Node.transactions.broadcast('transfer', transferData, currentWallet.keyPair);
        }
    }

    </script>

</head>
<body>


<div align="center">
    <button onclick="test()">TEST</button>
    <div id="initRepoId">
        https://github.com/
        <input type="text" value="VladislawKravchenok" size="20" id="profileId" placeholder="Profile name"/>
        /
        <input type="text" value="SolarSystem3" size="20" id="repositoryId" placeholder="Repository name"/>


        <button onclick="checkRepository()" id="createButtonId">Create wallet</button>
    </div>


    <div id="userWalletId"></div>
    <div id="userBalanceId"></div>
    <div id="userSeedId"></div>

    <input type="text" name="key" size="15" id="accountId"
           placeholder="Ссылка на гит аккаунт работника" hidden/>



    <input type="text" name="key" size="15" id="walletId"
           placeholder="Личный, Waves - кашелёк работника" hidden/>


<div id="container"></div>
<div id="buttonCreateSmartContract"></div>
<div id="containerTest"></div>
<div id="errorMessageId" style=" color: red"></div>
</div>
</body>
</html>